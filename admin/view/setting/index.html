<{extends file="layout.html"}>
<{block name="myStyles"}>
<style type="text/css">
    .file-exten-info-title {
        width: 120px!important;
    }

    .layui-form-item .layui-input-inline{
        width: 60px;
    }

    .layui-form-onswitch {
        border-color: #393D49;
        background-color: #393D49;
    }

    .layui-form-mid {
        line-height: 30px;
    }

    .file-detail-des-box {
        display: inline-block;
        font-weight: 300;
        height: 36px;
        line-height: 36px;
    }

    .drive-dir-tree-cache-title {
        width: 160px!important;
    }

    .select-box {
        width: 800px;
        position: relative;
    }

    .select-box .layui-form-select {
        width: 150px;
        display: inline-block;
    }

    .layui-form-select dl dd.layui-this {
        background-color: #393D49;
    }

    .none-cache-tip {
        position: relative;
        left: 0;
        top: 0;
        width: 800px;
        height: 200px;
        line-height: 200px;
        font-size: 30px;
        font-weight: 300;
        color: #cccccc;
        text-align: center;
        display: none;
    }

    .update-cache-btn,.reset-cache-btn {
        background-color: #393D49;
    }

    .layui-btn-disabled {
        background-color: #FBFBFB;
    }

</style>
<{/block}>
<{block name="scriptCode"}>
<script>
    // 选择的云盘类型
    var selectDriveType;
    // 选择的云盘
    var selectDrive;
    $(document).ready(function () {
        // 设置边栏服务器信息选中状态
        $("#setting").addClass("active");

        // 监听开关切换
        layui.use('form',function () {
            var form = layui.form;

            // 是否加载文件详情
            form.on('switch(load_file_detail_info_switch)', function (data) {
                var switchStatus = data.elem.checked;
                changeSwitchStatus(switchStatus);
            });

            // 监听云盘类型选择
            form.on('select(drive-type-list)', function(data){
                // 选择的云盘类型
                selectDriveType = data.value;
                // 刷新云盘列表
                createDriverSelectDoms();
            });

            // 监听云盘选择
            form.on('select(drive-list)', function(data){
                // 选择的云盘
                selectDrive = data.value;
                // 刷新文件夹缓存列表
                loadDirCache();
            });
        });

        // 加载设置项
        loadSettingData();

        // 请求云盘列表
        loadDriverList();
    });

    // 加载设置项
    function loadSettingData() {
        var url = "?m=admin&c=API_Setting&a=loadSetting&API=";
        get(url,function (data) {
            var settingData = data.data;
            // 设置页面按钮开关
            for (var i = 0; i < settingData.length; i++){
                var setData = settingData[i];
                if (setData.flag == "load_file_detail_info"){
                    // 是否加载文件详情
                    var status = parseInt(setData.status);
                    var switcher = $(".load_file_detail_info_switch");
                    layui.use('form',function () {
                        var form = layui.form;
                        status == 0 ? switcher.removeAttr('checked') : switcher.attr('checked',"");
                        form.render();
                    });
                }
            }
        },false);
    }

    // 设置开关状态
    function changeSwitchStatus(status) {
        var sta = status ? "1" : "0";
        var url = "?m=admin&c=API_Setting&a=changeSetting&API=&flag=load_file_detail_info&status=" + sta;
        get(url,function () {
            // 刷新设置页
            loadSettingData();
        },false);
    }

    // 请求云盘列表
    function loadDriverList() {
        var url = "?m=admin&c=API_FileManager&a=loadDriverList&API=";
        get(url,function (data) {
            driverList = data.data;

            // 默认选择的云盘类型
            var driveTypes = Object.keys(driverList);
            if (driveTypes.length > 0){
                selectDriveType = driveTypes[0];
            }

            // 默认选择的云盘
            if (selectDriveType.length > 0){
                selectDrive = driverList[selectDriveType][0];
            }

            // 创建云盘类型选择列表
            createDriverTypeSelectDoms();
            // 创建云盘选择列表
            createDriverSelectDoms();
            // 获取文件夹缓存列表
            loadDirCache();
        },false);
    }

    // 创建云盘类型选择列表
    function createDriverTypeSelectDoms() {
        var dom = '<option value="">选择云盘类型</option>';
        var driverTypes = Object.keys(driverList);

        for(var i = 0; i < driverTypes.length; i++){
            var driverT = driverTypes[i];
            if (selectDriveType == driverT){
                dom += '<option selected="selected" value="'+ driverT +'">'+ driverT +'</option>';
            }else {
                dom += '<option value="'+ driverT +'">'+ driverT +'</option>';
            }
        }

        layui.use('form',function () {
            var form = layui.form;
            $("#drive_type_select").html(dom);
            form.render();
        });
    }

    // 创建云盘选择列表
    function createDriverSelectDoms() {
        var dom = '<option value="">选择云盘</option>';
        if (selectDriveType.length > 0){
            var drives = driverList[selectDriveType];
            for(var i = 0; i < drives.length; i++){
                var driver = drives[i];
                if (selectDrive == driver){
                    dom += '<option selected="selected" value="'+ driver +'">'+ driver +'</option>';
                }else {
                    dom += '<option value="'+ driver +'">'+ driver +'</option>';
                }
            }
        }

        layui.use('form',function () {
            var form = layui.form;
            $("#drive_select").html(dom);
            form.render();
        });
    }

    // 获取文件夹缓存列表
    function loadDirCache() {
        var url = baseUrl + "?m=admin&c=API_Setting&a=loadDriveDirCache&API=&remoteName=" + selectDrive;
        console.log("获取文件夹缓存列表:" + url);
        get(url,function (data) {
            // 更新状态
            var status = parseInt(data.data.status);
            var $updateBtn = $(".update-cache-btn");
            if (status == 1){
                $updateBtn.text("缓存更新中");
                $updateBtn.addClass("layui-btn-disabled");
            }else {
                $(".single-driver-btn").text("更新缓存");
                $(".all-driver-btn").text("一键更新所有云盘");
                $updateBtn.removeClass("layui-btn-disabled");
            }
            var dirCache = data.data.data;
            if (dirCache.length > 0){
                // 有缓存
                $(".none-cache-tip").css("display","none");
                layui.use(['tree', 'util'], function(){
                    var tree = layui.tree
                        ,layer = layui.layer
                        ,util = layui.util;

                    //手风琴模式
                    tree.render({
                        elem: '#dir_cache_list'
                        ,data: dirCache
                        ,accordion: true,
                        click:function (obj) {
                            console.log(obj.data);
                        }
                    });
                });
            }else{
                // 没有缓存
                $(".none-cache-tip").css("display","block");
                $("#dir_cache_list").html("");
            }
        })
    }

    // 更新缓存
    function updateCache() {
        if ($(".update-cache-btn").hasClass("layui-btn-disabled")) return;
        var url = baseUrl + "?m=admin&c=API_Setting&a=updateDriveDirList&API=&remoteName=" + selectDrive;
        console.log("更新文件夹缓存:" + url);
        get(url,function () {
            // 更新成功 刷新缓存显示列表
            loadDirCache();
        },true,true);
    }
    
    // 更新所有云盘目录树缓存
    function updateAllCloudCache() {
        if ($(".update-cache-btn").hasClass("layui-btn-disabled")) return;
        var url = baseUrl + "?m=admin&c=API_Setting&a=updataAllDriverDirCache";
        console.log("更新所有云盘目录树:" + url);
        get(url,function () {
            // 更新成功 刷新缓存显示列表
            loadDirCache();
        },true,true);
    }

    // 复位目录树更新标志位
    function resetFlag() {
        var url = baseUrl + "?m=admin&c=API_Setting&a=resetFlag";
        get(url,null,false);
    }

</script>
<{/block}>
<{block name="content"}>
<div class="aw-content-wrap">
    <form class="layui-form" action="">
        <div class="layui-form-item">
            <label class="layui-form-label file-exten-info-title">加载文件额外信息</label>
            <div class="layui-input-inline">
                <input class="load_file_detail_info_switch" type="checkbox" checked="" name="open" lay-skin="switch" lay-filter="load_file_detail_info_switch" lay-text="ON|OFF">
            </div>
            <div class="layui-form-mid layui-word-aux">加载云盘/文件列表时同时加载文件总大小和文件总数量，开启后列表加载速度慢</div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label drive-dir-tree-cache-title">云盘文件夹树形列表缓存</label>
            <div class="layui-input-inline">
                <div class="layui-form-item select-box">
                    <select id="drive_type_select" lay-filter="drive-type-list">
                        <option value="">选择云盘类型</option>
                    </select>
                    <select id="drive_select" lay-filter="drive-list">
                        <option value="">选择云盘</option>
                    </select>
                    <button onclick="updateCache()" type="button" class="layui-btn update-cache-btn single-driver-btn">更新缓存</button>
                    <button onclick="updateAllCloudCache()" type="button" class="layui-btn update-cache-btn all-driver-btn">一键更新所有云盘</button>
                    <button onclick="resetFlag()" type="button" class="layui-btn reset-cache-btn">复位标志位</button>
                    <div id="dir_cache_list" class="dir-cache-list"></div>
                    <div class="none-cache-tip">没有缓存</div>
                </div>
            </div>
        </div>
    </form>
</div>

<{/block}>
