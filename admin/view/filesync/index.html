<{extends file="layout.html"}>
<{block name="myStyles"}>
<style type="text/css">
    .aw-content-wrap .icon {
        background-color: #393D49;
        margin-right: 10px;
    }

    .layui-table thead th{
        text-align: center;
        font-weight: bold;
    }

    .add-category-container {
        width: 430px;
        height: 180px;
        background-color: #FFF;
        padding: 10px;
        border-radius: 2px;
        position: relative;
        display: none;
    }

    .cover-title{
        width: 450px;
    }

    .layui-input-inline .layui-btn {
        color: #cdcdcd
    }

    .btns-box {
        width: 146px;
        position: absolute;
        right: 10px;
        bottom: 20px;
    }

    .btns-box .confirm-btn{
        background-color: #393D49;
    }

    .drive-name-input {
        color: #cccccc;
    }

    .tip-message {
        color: #cccccc;
        font-width: 300;
        font-size: 16px;
    }

    /*右下角添加分类/平台/账号/密码按钮*/
    .add-btn {
        position: fixed;
        right: 70px;
        bottom: 30px;
        background-color: #393D49;
        width: 40px;
        height: 40px;
        border-radius: 30px;
        border-color: transparent;
        cursor: pointer;
    }
    .add-btn img {
        width: 20px;
        height: 20px;
    }
    .add-btn:hover {
        opacity: 0.8;
    }

    .list-title {
        text-align: left;
    }
</style>
<{/block}>
<{block name="scriptCode"}>
<script>
    var layerIndex;
    var editDriverName;
    var editType;
    var oldDriverName;
    var editRow;
    var driverData = {};
    $(document).ready(function () {
        // 设置边栏服务器信息选中状态
        $("#file_sync").addClass("active");

        // 请求同步列表
        loadFileSyncList();
    });

    // 请求同步列表
    function loadFileSyncList() {
        var url = "?m=admin&c=API_FileSync&a=loadFileSyncList&API=";
        get(url,function (data) {
            // 创建同步列表
            createSyncListDoms(data.data);
        },true,false,1000000);
    }

    // 创建同步列表
    function createSyncListDoms(data) {
        var dom = "";
        for(var i = 0; i < data.length; i++){
            var syncsData = data[i];
            var syncId = syncsData["id"];
            dom += '<tr syncId="'+ syncId +'" ><td>'+ syncsData["typeStr"] +'</td>';
            dom += '<td><div class="source-path">'+ syncsData["source_path"] +'</div></td>';
            dom += '<td><div class="des-path">'+ syncsData["des_path"] +'</div></td>';
            dom += '<td>'+ syncsData["statusStr"] +'</td></tr>';
        }

        // 添加分类一行
        $("tbody").html(dom);

        // 添加右键菜单
        var menu_data=[
            {'type':1,'icon':'icon-zhongmingming','title':'编辑'},
            {'type':2,'icon':'icon-beizhu','title':'同步'},
            {'type':3,'icon':'icon-icon_del','title':'删除'}
        ];
        mouseRightMenuInit($(".layui-table tbody tr"),menu_data,function (menuData) {
            var opeType = menuData.type;
            switch (opeType) {
                case 1:
                    // 编辑

                case 2:
                    // 同步
                    showEditCover(opeType);
                    break;
                case 3:
                    // 删除
                    loadDriverInfo();
                    break;
            }
        },function (obj) {
            editRow = obj;
            editDriverName = obj.attr('driverName');
        });
    }

    // 获取云盘文件大小和文件数量
    function loadDriverInfo() {
        var url = baseUrl + "?m=admin&c=API_MyDriver&a=loadFileDetailInfo&driverName=" + editDriverName + "&API=";
        console.log("获取云盘详情：" + url);
        get(url,function () {
        },true,true);
    }

    // 显示编辑界面
    function showEditCover(type) {
        editType = type;
        var area = ['450px','200px'];
        var offset = '200px';
        $(".cover-title").css("width","430px");
        $(".add-category-container .layui-form").css("display","none");
        if (type == 1){
            var $input = $("#new_name_input");
            // 重命名
            $("#legend_title").text("重命名");
            $input.css("display","block");
            $(".add-category-container").css("width","430px");
            $(".add-category-container").css("height","180px");
            // 显示原来的名字
            $input.val(editDriverName);
            oldDriverName = editDriverName;
        }else {
            // 添加/修改备注
            $("#legend_title").text("修改云盘信息");
            $("#new_name_input").css("display","none");
            $(".add-category-container .layui-form").css("display","block");
            $(".add-category-container").css("width","780px");
            $(".add-category-container").css("height","480px");
            $(".cover-title").css("width","780px");
            area = ['800px','500px'];
            offset = '120px';

            var currentDriver = driverData[editDriverName];
            $("#drive_name").val(editDriverName);
            $("#main_admin").val(currentDriver["mainAdmin"]);
            $("#member_count").val(currentDriver["memberCount"]);
            $("#drive_remark").val(currentDriver["remark"]);
        }
        $(".add-category-container").css("display","block");
        layui.use('layer',function () {
            var layer = layui.layer;
            layerIndex = layer.open({
                type: 1,
                area:area,
                title: false,
                offset:offset,
                closeBtn: 0,
                shadeClose: true,
                content: $(".add-category-container"),
                success: function(){
                    if (type == 1){
                        // 自动获取焦点
                        $input.focus();
                        // // 文字被选中
                        $input.select();
                    }
                },
                end:function () {
                    $(".add-category-container").css("display","none");
                }
            });
        });
    }

    // 隐藏编辑界面
    function hideEditCover(){
        // 关闭浮层
        layui.use('layer', function() {
            var layer = layui.layer;
            layer.close(layerIndex);
        });
    }

    // 删除云盘
    function deleteDriver() {
        confirmAlert(function () {
            var url = baseUrl + "?m=admin&c=API_MyDriver&a=deleteDrive&name=" + editDriverName + "&API=";
            get(url,function () {
                // 刷新列表
                loadDriverList();
            },true,true);
        });
    }

    // 重命名
    function renameDriver(driveName) {
        var url = baseUrl + "?m=admin&c=API_MyDriver&a=renameDrive&oldName=" + oldDriverName + "&API=&newName=" + driveName;
        console.log("重命名云盘：" + url);
        get(url,function () {
            // 刷新列表
            loadDriverList();
        },true,true);
    }
    
    // 修改云盘信息
    function modifyDriveInfo(mainAdmin,memberCount,remark) {
        var url = baseUrl + "?m=admin&c=API_MyDriver&a=modifyDriveInfo"
            + "&driverName=" + editDriverName
            + "&API=&remark=" + remark
            + "&mainAdmin=" + mainAdmin
            + "&memberCount=" + memberCount;
        get(url,function () {
            // 刷新列表
            loadDriverList();
        },true,true);
    }

    // 确认
    function confirm() {
        if (editType == 1){
            // 重命名
            var newName = $('#new_name_input').val();
            if (newName.length == 0){
                toast("名称不能为空");
            }else if(newName == oldDriverName){
                toast("请输入不同的名称");
            }else {
                renameDriver(newName);
                hideEditCover();
            }
        }else {
            // 主管理员
            var mainAdmin = $("#main_admin").val();
            // 成员数
            var memberCount = $("#member_count").val();
            // 备注
            var remark = $("#drive_remark").val();
            modifyDriveInfo(mainAdmin,memberCount,remark);
            hideEditCover();
        }
    }

    // 取消
    function cancel() {
        hideEditCover();
    }

    // 更新所有盘使用详情
    function updateAllDriveUsedInfo() {
        var url = baseUrl + "?m=admin&c=API_MyDriver&a=updateAllDriveUsedInfo";
        get(url,null,true,true);
    }

</script>
<{/block}>
<{block name="content"}>
<div class="aw-content-wrap">
    <div class="layui-form" style="text-align: center;">
        <fieldset class="layui-elem-field layui-field-title list-title" style="margin-top: 20px;">
            <legend>同步列表</legend>
        </fieldset>
        <table class="layui-table">
            <colgroup>
                <col width="150">
                <col width="150">
                <col width="150">
                <col width="150">
            </colgroup>
            <thead>
            <tr>
                <th>同步类型</th>
                <th>源路径</th>
                <th>目标路径</th>
                <th>同步状态</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

<!--浮层弹窗-->
<div class="add-category-container">
    <fieldset class="layui-elem-field layui-field-title cover-title" style="margin-top: 20px;">
        <legend id="legend_title">重命名</legend>
    </fieldset>
    <input id="new_name_input" type="text" lay-verify="required" placeholder="请输入名称" autocomplete="off" class="layui-input">

    <form class="layui-form layui-form-pane" action="">
        <div class="layui-form-item">
            <label class="layui-form-label">云盘名称</label>
            <div class="layui-input-inline">
                <input readonly="readonly" id="drive_name" type="text" lay-verify="required" autocomplete="off" class="layui-input drive-name-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">主管理员</label>
            <div class="layui-input-inline main-admin">
                <input id="main_admin" type="text" lay-verify="required" placeholder="输入主管理员" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">成员数量</label>
            <div class="layui-input-inline">
                <input id="member_count" type="text" lay-verify="required" placeholder="输入成员数量" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-block">
                    <textarea style="resize: none;height: 150px" id="drive_remark" placeholder="输入备注信息" class="layui-textarea"></textarea>
                </div>
            </div>
        </div>
    </form>

    <!--确定/取消按钮-->
    <div class="btns-box">
        <button onclick="cancel()" type="button" class="layui-btn layui-btn-primary">取消</button>
        <button onclick="confirm()" type="button" class="layui-btn confirm-btn">确认</button>
    </div>
</div>

<!--添加按钮-->
<button type="button" class="add-btn" onclick="addData()">
    <img src="<{$data.imageUrl}>add.png">
</button>
<{/block}>
